#ifndef UIMessaging_h
#define UIMessaging_h

#include <Adafruit_SSD1306.h>
#include "GripUtil.h"
#include "Arduino.h"
#include "Messaging.h"

#define SPLASH_ENABLED true

#if (SPLASH_ENABLED == true)
static const unsigned char PROGMEM logo16_glcd_bmp[] =
    {B00000000, B00000001, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
     B00000000, B01110000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
     B00011100, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B11001110,
     B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000111, B00000000,
     B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B10001011, B10000000, B00000000,
     B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000101, B11000000, B00000000, B00000000,
     B00000000, B00000000, B00000000, B00000000, B00000000, B01000010, B11100000, B00000000, B00000000, B00000000,
     B00000000, B00000000, B00000000, B00000000, B00000001, B01110000, B00000000, B00000000, B00000000, B00000000,
     B00000000, B10000000, B00000000, B00000000, B00111000, B00000000, B00000000, B00000000, B00000000, B00000111,
     B00011110, B00000000, B00000000, B00011100, B00000000, B00000000, B00000000, B00000000, B11111000, B00000111,
     B11100000, B00000000, B00001110, B00000000, B00000000, B00000000, B00000011, B11000000, B00000000, B11111110,
     B00000001, B10000111, B00000000, B00000000, B00000000, B00011110, B00000000, B00110000, B00111111, B11000001,
     B01010011, B10000000, B00000000, B00000000, B01111000, B00000000, B00000001, B10001111, B11111000, B01000001,
     B11000000, B00011111, B11100001, B11100000, B00000000, B00000000, B00100001, B11111110, B00010000, B11000000,
     B01111111, B11111101, B11000000, B00000000, B00000000, B00000100, B01111111, B11000100, B11000001, B11111111,
     B11111011, B00000000, B00000000, B00000000, B01000000, B10001111, B11110000, B01000001, B11110000, B00000110,
     B00000000, B00000000, B00000001, B00001000, B00100011, B11111110, B01000011, B01110011, B00001100, B00000000,
     B00000000, B00000000, B10000001, B00000100, B11111111, B00100111, B11110111, B00001000, B00000000, B00000000,
     B00000000, B00010000, B01000001, B00011111, B10000011, B11110010, B00010000, B00000000, B00000000, B00000000,
     B00000100, B00001000, B00100111, B11000111, B11111100, B00110000, B00000000, B00000000, B00000000, B00000001,
     B00000000, B00010111, B11100111, B11111000, B00100000, B00000000, B00000000, B00000000, B00000000, B00010000,
     B01000011, B11100111, B11110000, B01000000, B00000000, B00000000, B00000000, B00000000, B00000010, B00010001,
     B11100111, B11110000, B01000000, B00000000, B00000000, B00000000, B00000000, B11001100, B00011100, B11100111,
     B11100000, B10000000, B00000000, B00000000, B00000000, B00000010, B00000000, B00110000, B01100111, B11000000,
     B10000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000010, B00100111, B10000001, B10000000,
     B00000000, B00000000, B00000000, B00000000, B01100000, B01100100, B00110111, B10000001, B00000000, B00000000,
     B00000000, B00000000, B00000000, B00011000, B10110000, B01010111, B00000001, B00000000, B00000000, B00000000,
     B00000000, B00000000, B00000000, B00001000, B00000111, B00000010, B00000000, B00000000, B00000000, B00000000,
     B00000000, B00000000, B10000000, B00000110, B00000010, B00000000, B00000000, B00000000, B00000000, B00000000,
     B00000000, B00000011, B00000110, B00000110, B00000000, B00000000, B00000000, B00000000, B00000000, B00000001,
     B11000010, B00000100, B00000100, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B01010000,
     B00000100, B00001100, B00000000, B00000000, B00000000, B00000000, B00000000, B00000100, B00000000, B00000000,
     B00011000, B00000000, B00000000, B00000000, B00000000, B00000000, B00001000, B00000000, B00001000, B00010000,
     B00000000, B00000000, B00000000, B00000000, B00000000, B00001000, B00000000, B00000000, B00110000, B00000000,
     B00000000, B00000000, B00000000, B00000000, B00010000, B00000000, B00000000, B01100000, B00000000, B00000000,
     B00000000, B00000000, B00000000, B00110000, B00000000, B00000000, B11000000, B00000000, B00000000, B00000000,
     B00000000, B00000000, B00110100, B00000000, B00000011, B10000000, B00000000, B00000000, B00000000, B00000000,
     B00000000, B01100100, B00000000, B00000111, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
     B01101100, B00000000, B00011110, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B01101110,
     B00000000, B01111100, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B11011110, B00000011,
     B11110000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B11011110, B01111111, B11000000,
     B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B11011110, B00000000, B00000000, B00000000,
     B00000000, B00000000, B00000000, B00000000, B00000000, B11111110, B00000000, B00000000, B00000000, B00000000,
     B00000000, B00000000, B00000000, B00000001, B11111110, B00000000, B00000000, B00000000, B00000000, B00000000,
     B00000000, B00000000, B00000001, B10111110, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
     B00000000, B00000001, B10111110, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
     B00000001, B10111110, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000001,
     B10111110, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000001, B10111110,
     B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000001, B10111100, B00000000,
     B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000001, B10111100, B00000000, B00000000,
     B00000000, B00000000, B00000000, B00000000, B00000000, B00000001, B10111100, B00000000, B00000000, B00000000,
     B00000000, B00000000, B00000000, B00000000, B00000001, B10111000, B00000000, B00000000, B00000000, B00000000,
     B00000000, B00000000, B00000000, B00000000, B10111000, B00000000, B00000000, B00000000, B00000000, B00000000,
     B00000000, B00000000, B00000000, B10110000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
     B00000000, B00000000, B10100000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
     B00000000, B10000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
     B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
     B00000000, B00000000, B00000000, B00000000, B00000000, B00000000
    };
#endif

#define OLED_RESET 21

#define NUMFLAKES 10
#define XPOS 0
#define YPOS 1
#define DELTAY 2

#define LOGO16_GLCD_HEIGHT 64
#define LOGO16_GLCD_WIDTH  72

#if (SSD1306_LCDHEIGHT != 64)
#error("Height incorrect, please fix Adafruit_SSD1306.h!");
#endif

class UIState {
 public:
    void setupScreen();
    void selectGrip(unsigned int);
    void selectGrip();
    void showGrip(unsigned int gripIndex);
    void showNextGrip();
    void showPreviousGrip();

    unsigned int getShownGripIndex() {
        return shownGripIndex;
    }
    unsigned int getSelectedGripIndex() {
        return selectedGripIndex;
    }

    unsigned int primaryIndex = 0;
    unsigned int secondaryIndex = 1;

 private:
    void flash(unsigned int t);
    void playLockAnimation();

    static Adafruit_SSD1306 display;
    const unsigned int offsetX = 20;
    const unsigned int offsetY = 20;
    unsigned int selectedGripIndex = 0;
    unsigned int shownGripIndex = 0;
};

/*!
 * @brief Handle structured serial communication between Arduinos
 */
class UIMessageHandler : public MessageHandler {
 public:
    explicit UIMessageHandler(UIState *state);
    void sendCurrentGripSelection();
 private:
    void interpretMessage(int length) final;
    void serializeGrip(const Grip &grip, char out[]);
    UIState *state;
};

#endif // UIMessaging_h
